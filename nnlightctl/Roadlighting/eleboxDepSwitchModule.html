<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit|ie-comp|ie-stand">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />

  <title>设备部署-控制柜部署-添加“开关模块”设备</title>

  <link rel="stylesheet" type="text/css" href="../css/common.css" />
  <link rel="stylesheet" type="text/css" href="../css/admin.css" />
  <link rel="stylesheet" type="text/css" href="../css/iconfont/iconfont.css" />

</head>
<body>
<article class="page-container">
  <form class="form form-horizontal" id="form-admin-add">
    <div style="width:49.5%;border:1px solid #ddd;height:420px;overflow:hidden;" class="mt-20 f-l">
      <table id="table" class="table table-border table-bordered">
        <thead>
          <tr class="text-l">
            <th width="25"></th>
            <th>模块编码</th>
            <th>模块名称</th>
            <th>模块型号</th>
            <th>通讯方式</th>
            <th>最大负载电流</th>
            <th>回路数</th>
            <th>备注</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>UUID：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="UUID" id="uid" name="uid">-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>模块名称：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="模块名称" id="centralizeName" name="centralizeName">-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>模块型号：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="模块型号" id="modularModel" name="centralizeName">-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>模块编码：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="模块编码" id="centralizeCode" name="centralizeCode">-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4">通讯方式：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="通讯方式" id="communicationMode" name="communicationMode">-->
          <!--<label id="powerRating-error" class="error" style="display:none">*格式不正确。</label>-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4">最大负载电流：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="最大负载电流" id="electricRating" name="electricRating">-->
          <!--<label id="electricRating-error" class="error" style="display:none">*格式不正确。</label>-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4">所属相序：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="所属相序" id="sequence" name="electricRating">-->
          <!--<label id="sequence-error" class="error" style="display:none">*格式不正确。</label>-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4">回路数量：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="回路数量" id="loopQuantity" name="electricRating">-->
          <!--<label id="loopQuantity-error" class="error" style="display:none">*格式不正确。</label>-->
        <!--</div>-->
      <!--</div>-->
      <!--<div class="row cl">-->
        <!--<label class="form-label col-xs-4 col-sm-4">状态：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-7">-->
          <!--<input type="text" class="input-text" value="" placeholder="额定电压" id="voltageRating" name="voltageRating">-->
          <!--<label id="voltageRating-error" class="error" style="display:none">*格式不正确。</label>-->
        <!--</div>-->
      <!--</div>-->
    </div>
    <div style="width:49.5%;border:1px solid #ddd;height:420px;overflow:hidden;" class="mt-20 f-r">
      <h3 class="f-20">
        <span class="pl-10">回路</span>
        <a class="btn btn-primary radius f-r mr-10" data-title="添加回路" onclick="addLoop('编辑回路', 'switchModuleLoop.html', '540', '440')" href="javascript:void(0);">
          <i class="Hui-iconfont">&#xe600;</i>编辑回路
        </a>
      </h3>
      <div style="overflow-y:scroll;height:490px;width:100%;" class="mt-10">
        <table id="modelLoopTable" class="table table-border table-bordered">
          <thead>
          <tr class="text-c">
            <th>回路编号</th>
            <th>单灯控制器</th>
            <th>备注</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
    <div class="clear"></div>

  </form>
</article>
<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" src="../lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript" src="../js/admin.js"></script>

<script type="text/javascript" src="../js/api/requestRoot.js"></script>
<script type="text/javascript" src="../js/api/ajaxScript.js"></script>
<script type="text/javascript" src="../lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
<!--/_footer 作为公共模版分离出去-->
<script type="text/javascript">
  console.log("开关模块");
  var table = null;
  var modelLoopObj = {};//存储数据的全局变量
  $(function(){
    setTimeout(function(){//等框完全展开后初始化表格
      getDepSwitchModeInfo()
    },300);

  });
  function getDepSwitchModeInfo(){
    table = $('#table').DataTable({
      "bStateSave": true,
      "destroy": true,
      "searching": false,
      "autoWidth": true,
      "pageLength": 10,
      "info": false,
      "lengthChange": false,
      "ordering": false, //设置所有不排序
      "ajax": function (data, callback, settings) {
        ajaxRequest("post", "api/roadlighting/listmodel", {pageNumber:1, pageSize:10}, function (result) {
          //封装返回数据
          var returnData = {};
          if (result) {
            if (result.header.code == 1000) {
              var dataList = result.body.data;
              $.each(dataList,function(n,value) {
                value['equType'] = "开关模块";
                if (value.state == 1){
                  dataList.splice(n,1);
                }
              });
              returnData.data = dataList;
              callback(returnData);
            } else {
              layer.msg("出错啦！！！", { icon: 2, time: 3000 });
            }
          }
        });
      },
      "columnDefs": [//对table格式的定义（表格的列从0开始）
        {
          sClass:"tr-select",
          targets: 0,
          render: function (data, type, row) {
            return '<input type="radio" name="table-select" value="' + row.id + '" >';
          }
        }
      ],
      "columns": [//返回的json数据在这里填充，注意一定要与上面的<th>数量对应，否则排版出现扭曲
        { "data": "id"},
        { "data": "modelCode", "defaultContent": "" },
        { "data": "modelName", "defaultContent": "" },
        { "data": "modelType", "defaultContent": "" },
        { "data": "communicationMethods", "defaultContent": "" },
        { "data": "maxElectric", "defaultContent": "" },
        { "data": "loopCount", "defaultContent": ""},
        { "data": "mem", "defaultContent": ""}
      ]
    });

  }

  //添加回路
  function addLoop(title, url, w, h) {
    var checkedTr = $(".tr-select").children("input:checked").parent().parent();
    var deviceData = table.row( checkedTr ).data();
    if(deviceData == undefined || deviceData == ""){
      layer.msg("请选择开关模块", { icon: 2, time: 3000 });
    }else{
      layer_show(title, url+"?id="+deviceData.id, w, h, function (modelLoop) {
        //保存到全局模块回路数组中
        var index = modelLoopObj['modelLoopRequests'] = modelLoop;
        //添加到回路表格中
        var $tbody = $("#modelLoopTable").find("tbody").eq(0);
        //构造编辑时回路字符参数
        var urlParam = object2UrlParamStr(modelLoop);
        $('<tr value="'+index+'" class="text-c">\n' +
          '<td>'+modelLoop.loopCode+'</td>\n' +
          '<td>'+modelLoop.lightingList+'</td>\n' +
          '<td>'+modelLoop.mem+'</td>\n' +
          '<td><a style="text-decoration:none" class="ml-5" onclick="editLoop(this, \'编辑回路\', \'switchModuleLoop.html\', \''+urlParam+'\', \'420\', \'350\')" href="javascript:void(0);" title="回路编辑"><i class="Hui-iconfont">&#xe6df;</i></a></td>\n' +
          '</tr>').appendTo($tbody);
      });
    }
  }
  //编辑回路
  function editLoop(obj, title, url, param, w, h) {
    var index = $(obj).parents("tr").eq(0).attr("value");
    layer_show(title, url + "?id=" + param, w, h, function (modelLoop) {
      if (modelLoop.loopCode == "" || modelLoop.loopCode == undefined) {
        layer.msg("请输入回路编号！", { icon: 2, time: 2000 });
        return false;
      }
      //更新数组
      modelLoopObj[index] = modelLoop;
      //构造编辑时回路字符参数
      var urlParam = object2UrlParamStr(modelLoop);
      //更新表格
      $("#modelLoopTable").find("tbody").find("tr").eq(index).replaceWith('<tr value="'+index+'" class="text-c">\n' +
        '<td class="voltage">'+modelLoop.loopCode+'</td>\n' +
        '<td class="electricity">'+modelLoop.lightingList+'</td>\n' +
        '<td class="grade">'+modelLoop.mem+'</td>\n' +
        '<td class="active"><a style="text-decoration:none" class="ml-5" onclick="editLoop(this, \'编辑回路\', \'switchModuleLoop.html\', \''+urlParam+'\', \'420\', \'350\')" href="javascript:void(0);" title="回路编辑"><i class="Hui-iconfont">&#xe6df;</i></a></td>\n' +
        '</tr>');
    });
  }

  var getData = function () {
    if(!(modelLoopObj.hasOwnProperty("modelLoopRequests"))){
      return false;
    }
    //获取集中控制器选中数据
    var checkedTr = $(".tr-select").children("input:checked").parent().parent();
    var deviceData = table.row( checkedTr ).data();
    if(!(deviceData == undefined || deviceData == '')){
      $.each(deviceData,function(i,val){
        modelLoopObj[i] = val
      });
    }else{
      return ''
    }
    return modelLoopObj;
  };

</script>
<!--/请在上方写此页面业务相关的脚本-->
</body>

</html>


