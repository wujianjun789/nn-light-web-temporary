<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>

    <title>添加控制柜</title>

    <!--<link rel="stylesheet" href="../css/bootstrap/css/bootstrap.min.css">-->
    <link rel="stylesheet" type="text/css" href="../css/common.css"/>
    <link rel="stylesheet" type="text/css" href="../css/admin.css"/>
    <link rel="stylesheet" type="text/css" href="../css/iconfont/iconfont.css"/>

</head>
<body>
<article class="page-container">
    <form class="form form-horizontal" id="form-admin-add">

        <div class="row cl">
            <label class="form-label text-r f-l" style="width:100px;display:inline-block;">控制柜编号：</label>
            <div class="formControls col-xs-4 col-sm-4 text-l" style="width:150px;">
              <select class="input-text" id="equipmentCode" name="equipmentCode">
                <option value="1">312</option>
                <option value="2">431</option>
                <option value="3">321</option>
                <option value="4">412</option>
                <option value="5">3213</option>
              </select>
            </div>
            <label class="form-label text-r f-l" style="width:100px;display:inline-block;">设备类型：</label>
            <div class="formControls col-xs-4 col-sm-4 text-l" style="width:150px;">
                <select class="input-text" id="equipmentType" name="equipmentType"></select>
            </div>
            <a class="btn btn-primary radius f-r mr-10" data-title="添加设备" onclick="addTypeDevice('添加设备')" href="javascript:void(0);">
                <i class="Hui-iconfont">&#xe600;</i>添加设备
            </a>
        </div>
        <div style="width:100%;border:1px solid #ddd;overflow:hidden;" class="mt-20">
            
            <h3 class="f-20">
                <span class="pl-10">设备</span>
            </h3>
            <div style="overflow-y:scroll;height:400px;width:100%;" class="mt-10">
                <table class="table table-border table-bordered">
                    <thead>
                    <tr class="text-c">
                        <th>设备类别</th>
                        <th>设备编码</th>
                        <th>设备名称</th>
                        <th>设备型号</th>
                        <!--<th>状态</th>-->
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="equipmentTBody"></tbody>
                </table>
            </div>
        </div>

    </form>

    <div class="row cl mt-20">
        <div style="text-align:center;">
            <input id="btnSubmit" class="btn btn-primary radius" type="button" value="&nbsp;&nbsp;提交&nbsp;&nbsp;" style="width:200px;">
        </div>
    </div>
</article>
<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" src="../lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript" src="../js/admin.js"></script>

<script type="text/javascript" src="../js/api/requestRoot.js"></script>
<script type="text/javascript" src="../js/api/ajaxScript.js"></script>
<!--请在下方写此页面业务相关的脚本-->
<!--<script type="text/javascript" src="../js/bootstrap-treeview/bootstrap-treeview.min.jsd"></script>-->
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript">

    //控制柜包含模块集合
    var modelArray = [];
    //添加设备
    function addTypeDevice(title) {
      var equipmentType = $("#equipmentType").val();
      if(equipmentType == 1) {//电表
        addDevice(title,'addElectricityMete.html','900','540')
      }else if(equipmentType == 2){//集中控制器
        addDevice(title,'addDevice.html','900','600','/api/roadlighting/addOrUpdateLightModel')
      }else if(equipmentType == 3){//开关模块
        addDevice(title, 'eleboxDepSwitchModule.html', '', '','/api/roadlighting/addOrUpdateLightModel')
      }else if(equipmentType == 4){//光照计
        addDevice(title, 'eleboxDepPhotoperiod.html', '900', '600','/api/roadlighting/addOrUpdateLightModel')
      }
    }
    //不同类型添加的设备
    function addDevice(title,url,w,h){
      layer_show(title, url, w, h,function (deviceArray) {
        console.log(deviceArray);
        var $tbody = $("#equipmentTBody");
        deviceArray = [deviceArray];
        for (var i = 0; i < deviceArray.length; ++i) {
          var index = modelArray.push(deviceArray[i]) - 1;
          var paramStr = object2UrlParamStr(deviceArray[i]);
          //添加入表格中
          if(deviceArray[i].equType == '电表'){
            $('<tr value="' + index + '" class="text-c">\n' +
              '<td>' + deviceArray[i].equType + '</td>\n' +
              '<td>' + deviceArray[i].equipmentNumber + '</td>\n' +
              '<td>' + deviceArray[i].electricityName + '</td>\n' +
              '<td>' + deviceArray[i].electricityModel + '</td>\n' +
//              '<td>' + deviceArray[i].state + '</td>\n' +
              '<td><a href="javascript:void(0);" style="text-decoration:none" class="ml-5" onclick="editDevice(this, \'编辑设备\', \'editDevice.html\', \'' + paramStr + '\', \'800\', \'500\')" title="编辑设备"><i class="Hui-iconfont">&#xe6df;</i></a>' +
              '<a style="text-decoration:none" class="ml-5" onclick="deleteDevice(this)" href="javascript:void(0);" title="删除设备"><i class="Hui-iconfont">&#xe6e2;</i></a></td>\n' +
              '</tr>').appendTo($tbody);
          }else{
            $('<tr value="' + index + '" class="text-c">\n' +
              '<td>' + deviceArray[i].modelCode + '</td>\n' +
              '<td>' + deviceArray[i].modelName + '</td>\n' +
              '<td>' + deviceArray[i].loopCount + '</td>\n' +
              '<td>' + deviceArray[i].state + '</td>\n' +
              '<td>' + deviceArray[i].remarks + '</td>\n' +
              '<td><a href="javascript:void(0);" style="text-decoration:none" class="ml-5" onclick="editDevice(this, \'编辑设备\', \'editDevice.html\', \'' + paramStr + '\', \'800\', \'500\')" title="编辑设备"><i class="Hui-iconfont">&#xe6df;</i></a>' +
              '<a style="text-decoration:none" class="ml-5" onclick="deleteDevice(this)" href="javascript:void(0);" title="删除设备"><i class="Hui-iconfont">&#xe6e2;</i></a></td>\n' +
              '</tr>').appendTo($tbody);
          }

        }
      });
    }
    //编辑设备
    function editDevice(obj, title, url, param, w, h) {
        var index = $(obj).parents("tr").eq(0).attr("value");

        layer_show(title, url + "?" + param, w, h, function (data) {
            /*if (data.modelCode == "" || data.modelCode == undefined) {
                layer.msg("请输入模块编码！", { icon: 2, time: 2000 });
                return false;
            }
            if (data.modelName == "" || data.modelName == undefined) {
                layer.msg("请输入模块名称！", { icon: 2, time: 2000 });
                return false;
            }*/
            //更新数组
            var modelLoopArray = modelArray[index].modelLoopList;
            data["modelLoopList"] = modelLoopArray;
            modelArray[index] = data;

            //构造编辑时回路字符参数
            var urlParam = object2UrlParamStr(data);

            //更新表格
            $("table.table").find("tbody").find("tr").eq(index).replaceWith('<tr value="' + index + '" class="text-c">\n' +
                '<td>' + data.modelCode + '</td>\n' +
                '<td>' + data.modelName + '</td>\n' +
                '<td>' + data.loopCount + '</td>\n' +
                '<td>' + data.ac + '</td>\n' +
                '<td>' + data.voltageRating + '</td>\n' +
                '<td>' + data.electricRating + '</td>\n' +
                '<td><a href="javascript:void(0);" style="text-decoration:none" class="ml-5" onclick="editDevice(this, \'编辑设备\', \'editDevice.html\', \'' + urlParam + '\', \'800\', \'500\')" title="编辑设备"><i class="Hui-iconfont">&#xe6df;</i></a>' +
                '<a style="text-decoration:none" class="ml-5" onclick="deleteDevice(this)" href="javascript:void(0);" title="删除设备"><i class="Hui-iconfont">&#xe6e2;</i></a></td>\n' +
                '</tr>');

        });
    }

    //删除设备
    function deleteDevice(obj) {
        var $tr = $(obj).parent().parent("tr").eq(0);
        var index = $tr.attr("value");
        $tr.remove();
        modelArray[index] = null;
    }

    $(function () {
      //设备类型联动设备型号
      var equipmentData = [
          {"type":"电表","code":1,"items":[{"name":"ASD","model":"12","id":1},{"name":"QWE","model":"10","id":2},{"name":"ZXC","model":"6","id":3}]},
          {"type":"集中控制器","code":2,"items":[{"name":"aaa","model":"4","id":7},{"name":"ttt","model":"5","id":2},{"name":"kkk","model":"7","id":33}]},
          {"type":"开关模块","code":3,"items":[{"name":"bbb","model":"5","id":5},{"name":"rrr","model":"7","id":6},{"name":"lll","model":"12","id":44}]},
          {"type":"光照计","code":4,"items":[{"name":"ccc","model":"3","id":9},{"name":"uuu","model":"9","id":7},{"name":"mmm","model":"4","id":65}]}
      ];
      for(var i=0;i<equipmentData.length;i++){
        var item = equipmentData[i];
        $("#equipmentType").append('<option value="'+item.code+'">'+item.type+'</option>')
      }

      //提交按扭事件
      $("#btnSubmit").click(function (e) {
          ajaxRequest("post", "/api/roadlighting/addelebox",
              transArray({"count" : $("#count").val().trim(), "deviceList" : modelArray}), function (data) {
                  if (data) {
                      if (data.header.code == 1000) {
                          layer.msg("添加控制柜成功！", {icon : 1, time : 3000});
                      } else {
                          layer.msg(data.header.msg, {icon : 2, time : 3000});
                      }
                  }
              });
          ResetWindow();
          //var index = parent.layer.getFrameIndex(window.name);
          //parent.$('.btn-refresh').click();
          //parent.layer.close(index);
      });

    });
</script>
<!--/请在上方写此页面业务相关的脚本-->
</body>

</html>


