<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>

    <title>灯具道路地理信息--新建任务开关</title>
    <link rel="stylesheet" type="text/css" href="../css/common.css"/>
    <link rel="stylesheet" type="text/css" href="../css/admin.css"/>
    <link rel="stylesheet" type="text/css" href="../css/iconfont/iconfont.css"/>
    <style rel="stylesheet">
        .generally {
            display: block;
        }

        .holiday {
            display: none;
        }

        #sureRules {
            display: none;
        }

        .time-select {
            display: none;
        }
    </style>
</head>
<body>
<div class="page-container">
    <form class="form form-horizontal" id="form-admin-add">
        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-3 text-r"><span class="c-red">*</span>任务开关名称：</label>
            <div class="formControls col-xs-9 col-sm-9">
                <input type="text" class="input-text" value="" placeholder="任务开关名称" id="switchName" name="switchName">
            </div>
        </div>
        <div class="row cl mt-10">
            <label class="form-label col-xs-3 col-sm-3 text-r"><span class="c-red">*</span>周期：</label>
            <div class="formControls col-xs-9 col-sm-9">
        <span class="select-box" id="period" name="period" style="width:150px;">
            <label><input name="period" id="period1" type="radio" value="1" checked
                          onclick="changePeriod()"/>平常 </label>
            <label><input name="period" id="period3" type="radio" value="4" onclick="changePeriod()"/>节假日 </label>
        </span>
            </div>
        </div>
        <div class="row cl mt-10 generally">
            <label class="form-label col-xs-3 col-sm-3 text-r"><span class="c-red">*</span>定时设置：</label>
            <div class="formControls col-xs-9 col-sm-9">
                <input type="text" class="input-text" style="width:150px;"
                       onfocus="WdatePicker({dateFmt:'HH:mm:ss',minDate:'00:00:00',quickSel:['%H-00-00','%H-15-00','%H-30-00','%H-45-00']})"
                       id="startTime" placeholder="开始时间">
                -
                <input type="text" class="input-text" style="width:150px;"
                       onfocus="WdatePicker({dateFmt:'HH:mm:ss',minDate:'00:00:00',quickSel:['%H-00-00','%H-15-00','%H-30-00','%H-45-00']})"
                       id="endTime" placeholder="结束时间">
            </div>
        </div>
        <div class="row cl mt-10 holiday">
            <label class="form-label col-xs-3 col-sm-3 text-r"><span class="c-red">*</span>定时设置：</label>
            <div class="formControls col-xs-9 col-sm-9">
                <input type="text" class="input-text" style="width:150px;"
                       onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})"
                       id="startDate" placeholder="选择开始日期">
                <input type="text" class="input-text" style="width:150px;"
                       onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})"
                       id="endDate" placeholder="选择结束日期">
                <!-- - -->
                <button type="button" style="background: #5a98de;color: #fff;border: none;padding: 5px 3px;"
                        id="addRules">添加时间规则
                </button>
                <button type="button" style="background: #5a98de;color: #fff;border: none;padding: 5px 3px;"
                        id="sureRules">完成
                </button>
            </div>
        </div>
        <div class="selectedRules">
            <!--<div class="row cl mt-10">-->
            <!--<label class="form-label col-xs-3 col-sm-3 text-r">已选择的：</label>-->
            <!--<div class="formControls col-xs-9 col-sm-9">-->
            <!--<span class="f-14">时间点: </span><input type="text" class="input-text" style="width:50px;"-->
            <!--value="12:00">-->
            <!--<span class="f-14">调光百分比: </span><input type="text" class="input-text" style="width:50px;"-->
            <!--value="50">-->
            <!--<button type="button" style="background: #5a98de;color: #fff;border: none;padding: 5px 5px;">删除-->
            <!--</button>-->
            <!--</div>-->
            <!--</div>-->
        </div>
        <div class="row cl mt-10 time-select">
            <label class="form-label col-xs-3 col-sm-3 text-r"><span class="c-red">*</span>时间点选择：</label>
            <div class="formControls col-xs-9 col-sm-9">
                <input type="text" class="input-text" style="width:150px;"
                       onfocus="WdatePicker({dateFmt:'HH:mm',minDate:'08:00:00',quickSel:['%H-00','%H-15','%H-30','%H-45']})"
                       id="holidayTime" placeholder="开始时间">
            </div>
        </div>
        <div class="row cl mt-10 percent">
            <label class="form-label col-xs-3 col-sm-3 text-r">调光控制：</label>
            <div class="formControls col-xs-9 col-sm-4">
                <input type="text" class="input-text" value="" placeholder="调光控制百分比" id="lightPercent"
                       name="lightPercent">
            </div>
        </div>
        <!--<div class="row cl mt-10">-->
        <!--<label class="form-label col-xs-4 col-sm-3 text-r">是否启用光照计：</label>-->
        <!--<div class="formControls col-xs-8 col-sm-9">-->
        <!--<span class="select-box" style="width:150px;">-->
        <!--<select class="select" name="isUsebeam" id="isUsebeam" size="1">-->
        <!--<option value="1">是</option>-->
        <!--<option value="0">否</option>-->
        <!--</select>-->
        <!--</span>-->
        <!--</div>-->
        <!--</div>-->
        <div class="row cl mt-10">
            <label class="form-label col-xs-3 col-sm-3 text-r">是否开灯：</label>
            <div class="formControls col-xs-9 col-sm-9">
                <span class="select-box" style="width:150px;">
                    <select class="select" name="isLighton" id="isLighton">
                        <option value="1">是</option>
                        <option value="0">否</option>
                    </select>
                </span>
            </div>
        </div>
        <div class="row cl mt-20">
            <div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
                <input class="btn btn-primary radius" type="submit" value="&nbsp;&nbsp;提交&nbsp;&nbsp;">
            </div>
        </div>
    </form>
</div>

<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript" src="../js/admin.js"></script>

<script type="text/javascript" src="../js/api/requestRoot.js"></script>
<script type="text/javascript" src="../js/api/ajaxScript.js"></script>
<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="../lib/layer/2.4/layer.js"></script><!--弹出插件-->
<script type="text/javascript" src="../lib/My97DatePicker/4.8/WdatePicker.js"></script> <!--日期插件-->

<!--/_footer 作为公共模版分离出去-->
<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript">
  var holidayRules = []

  function changePeriod () {
    if ($('input[name=period]:checked').val() == 4) {
      $('.holiday').show()
      $('.selectedRules').show()
      $('.generally').hide()
      $('.percent').hide()
    } else {
      $('#lightPercent').val('')
      $('.holiday').hide()
      $('.selectedRules').hide()
      $('.time-select').hide()
      $('.generally').show()
      $('.percent').show()
    }
  }

  function deleteRuels (index) {
    holidayRules[index].isAdd = false;
    $('.selectedRules>div').eq(index).hide()
  }

  $(function () {
    $('.skin-minimal input').iCheck({
      checkboxClass: 'icheckbox-blue',
      radioClass: 'iradio-blue',
      increaseArea: '20%'
    });
    $('#addRules').click(function () {
      if ($('#startDate').val() == '') {
        layer.msg('请先选择日期', {icon: 2, time: 1000});
        return
      }
      $(this).hide()
      $('.time-select').show()
      $('.percent').show()
      $('#sureRules').show()
    })
    $('#sureRules').click(function () {
      $(this).hide()
      if ($('#holidayTime').val() && 0 <= $('#lightPercent').val() <= 100) {
        holidayRules.push({
          beginTime: str2Date('2019-01-01 ' + $('#holidayTime').val()),
          lightPercent: $('#lightPercent').val(),
          switchTaskInfoId: null,
          isAdd: true
        })
        var str = '<div class="row cl mt-10">' +
        '<label class="form-label col-xs-3 col-sm-3 text-r">已选择的：</label>' +
        '<div class="formControls col-xs-9 col-sm-9">' +
        '<span class="f-14">时间点: </span><input type="text" class="input-text" disabled style="width:50px;" value="' + $('#holidayTime').val() + '"> ' +
        '<span class="f-14">调光百分比: </span><input type="text" class="input-text" disabled style="width:50px;" value="' + $('#lightPercent').val() + '"> ' +
        '<button type="button" style="background: #5a98de;color: #fff;border: none;padding: 5px 5px;" onclick="deleteRuels(' + (holidayRules.length - 1) + ')">删除 </button>' +
        '</div>' +
        '</div>'
        $('.selectedRules').append(str)
      } else {
        layer.msg('填写错误', {icon: 2, time: 1000});
        return;
      }
      $('.time-select').hide()
      $('.percent').hide()
      $('#addRules').show()
    })
    //数据验证
    $("#form-admin-add").validate({
      rules: {
        taskSwitch: {
          required: true,
          minlength: 1,
          maxlength: 64
        }
      },
      onkeyup: false,
      focusCleanup: true,
      success: "valid",
      submitHandler: function (form) {
        //ajax上传表单
        //构造上传数据
        var flag = false
        holidayRules.forEach(function (val) {
          if (val.isAdd) {
            flag = true
          }
        })
        if (!flag && $('input[name=period]:checked').val() == 4) {
          layer.msg('请选择时间点', {icon: 2, time: 1000});
          return
        }
        var param = {};
        var paramArray = $(form).serializeArray();
        var isLighton = $("#isLighton").val();
        for (var i = 0; i < paramArray.length; ++i) {
          var o = paramArray[i];
          param[o["name"]] = o["value"];
        }
        if (isLighton == 0) {
          param["isLighton"] = 0
        } else {
          param["isLighton"] = 1
        }
        var period = ($("#period3").is(":checked") ? 4 : 0) + ($("#period1").is(":checked") ? 1 : 0);
        param["period"] = period
        if (period == 1) {
          var startdate = str2Date('2018-01-01 ' + $("#startTime").val());
          var enddate = str2Date('2019-01-01 ' + $("#endTime").val());
        } else {
          param["switchTaskInfoArray"] = []
          holidayRules.forEach(function (value) {
            if (value.isAdd) {
              param["switchTaskInfoArray"].push(value)
            }
          })
          param['lightPercent'] = null
          var startdate = str2Date($("#startDate").val());
          var enddate = str2Date($("#endDate").val());
        }
        param["startTime"] = startdate;
        param["endTime"] = enddate;
        param["id"] = editModel(window.location.href);

        $.ajax({
          method: 'POST',
          contentType: "application/json",
          url: BASE_ROOT + '/api/switchTask/addOrUpdateSwitchTask',
          data: JSON.stringify(param),
          // dataType: "json",
          success: function (data) {
            if (data) {
              if (data.header.code == 1000) {
                if (editModel(window.location.href)) {
                  layer.msg("编辑任务开关信息成功！", {icon: 1, time: 3000});
                } else {
                  layer.msg("添加任务开关信息成功！", {icon: 1, time: 3000});
                }
                ResetWindow();
              } else {
                layer.msg('操作失败', {icon: 2, time: 3000});
              }
            }
          }
        })
        // ajaxRequest("post", "/api/switchTask/addOrUpdateSwitchTask", param, function (data) {
        //   if (data) {
        //     if (data.header.code == 1000) {
        //       if (editModel(window.location.href)) {
        //         layer.msg("编辑任务开关信息成功！", {icon: 1, time: 3000});
        //       } else {
        //         layer.msg("添加任务开关信息成功！", {icon: 1, time: 3000});
        //       }
        //       ResetWindow();
        //     } else {
        //       layer.msg('操作失败', {icon: 2, time: 3000});
        //     }
        //   }
        // });
      }
    });

    //判断是否编辑模式
    var id = editModel(window.location.href);
    if (id) {
      ajaxRequest("post", "/api/switchTask/getSimpleSwitchTask", {"id": id}, function (data) {
        if (data) {
          if (data.header.code == 1000) {
            var taskSwitch = data.body.data[0];
            var tp = taskSwitch.period;
            $("#period1").attr("disabled", true);
            $("#period3").attr("disabled", true);
            ajaxRequest("post", "/api/switchTask/listSwitchTask", {"switchName": taskSwitch.switchName}, function (d) {
              var simpleSwitch = d.body.data[0];
              var startDate = new Date(simpleSwitch.startTime)
              var endDate = new Date(simpleSwitch.endTime)
              if (simpleSwitch.period == 4) {
                $("#startDate").val(startDate.getFullYear() + '-' + startDate.getMonth() + '-' + startDate.getDate())
                $("#endDate").val(endDate.getFullYear() + '-' + endDate.getMonth() + '-' + endDate.getDate())
                simpleSwitch.infos.forEach(function (i) {
                  holidayRules.push({
                    lightPercent: i.lightPercent,
                    beginTime: new Date(i.beginTime),
                    switchTaskInfoId: i.id,
                    isAdd: true
                  })
                  var str = '<div class="row cl mt-10">' +
                  '<label class="form-label col-xs-3 col-sm-3 text-r">已选择的：</label>' +
                  '<div class="formControls col-xs-9 col-sm-9">' +
                  '<span class="f-14">时间点: </span><input type="text" class="input-text" disabled style="width:50px;" value="' + new Date(i.beginTime).getHours() + ':' + new Date(i.beginTime).getMinutes() + '"> ' +
                  '<span class="f-14">调光百分比: </span><input type="text" class="input-text" disabled style="width:50px;" value="' + i.lightPercent + '"> ' +
                  '<button type="button" style="background: #5a98de;color: #fff;border: none;padding: 5px 5px;" onclick="deleteRuels(' + (holidayRules.length - 1) + ')">删除 </button>' +
                  '</div>' +
                  '</div>'
                  $('.selectedRules').append(str)
                })
              } else {
                $("#startTime").val(startDate.getHours() + ':' + startDate.getMinutes());
                $("#endTime").val(endDate.getHours() + ':' + endDate.getMinutes());
              }
            })
            if (tp == 1) {
              $("#period1").attr("checked", true);
            } else {
              $("#period3").attr("checked", true);
            }
            changePeriod();
            //刷新表单
            $("#switchName").val(taskSwitch.switchName);
            $("#isLighton").val(taskSwitch.isLighton);
            $("#lightPercent").val(taskSwitch.lightPercent);
          } else {
            layer.msg(data.header.msg, {icon: 2});
          }
        }
      });
    }
  });
</script>

</body>
</html>
